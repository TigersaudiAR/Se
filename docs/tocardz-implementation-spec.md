# وثيقة طلب تطوير منصة "توكاردز"

## الهدف العام
ترقية واجهة وتجربة الاستخدام (UI/UX) وبنية الصلاحيات والتكاملات بحيث تصبح المنصة مركزًا موحّدًا لإدارة المنتجات الرقمية، المخزون، المحادثات، الحملات، التنبيهات، والتقارير مع ربط حقيقي 100٪ مع مقدّمي الخدمات المعتمدين (زد، واتساب كلود، إنستغرام/فيسبوك، البريد، وغيرها) دون أي محاكاة.

---

## 1. واجهة الإعدادات الجديدة (Settings Hub)
- **أسلوب العرض**: شبكة بطاقات (Grid) من عمودين إلى ثلاثة على الجوال، ومن أربعة إلى ستة على سطح المكتب.
- **محتوى البطاقة**: أيقونة دلالية، اسم القسم، وصف قصير من سطر واحد، وشارة حالة الربط (متصل/غير متصل).
- **الأزرار**: زر "إدارة" لفتح صفحة القسم، وزر "صلاحيات" يظهر فقط للمسؤول.
- **الأقسام الأساسية**:
  1. ربط المنصات (زد، كتالوج واتساب، إنستغرام/فيسبوك، سناب في حال توفر API رسمي).
  2. الموظفون والأدوار (RBAC).
  3. المخزون والقسائم.
  4. الفوترة والفواتير.
  5. النشاط والتدقيق (Audit & Activity).
  6. البريد والتذاكر.
  7. المحادثات الموحّدة (Unified Inbox).
  8. الحملات والتسويق.
  9. التنبيهات والأمن (Outbound & Suspicious Connections).
  10. التقارير والجرد.
  11. الذكاء الاصطناعي (تحسين وصف/SEO/صور).
  12. التكاملات الإضافية (Webhooks، مفاتيح API).
- **متطلبات تصميمية**: دعم RTL كامل، ثيم فاتح/داكن، انتقالات ناعمة (Framer Motion أو CSSTransition)، زوايا دائرية 2XL، ظلال خفيفة، عناصر قابلة للطباعة.

---

## 2. نظام الصلاحيات (RBAC) دقيق وقابل للتخصيص
- **الأدوار الجاهزة**: owner، admin، finance، inventory_manager، seller، support، analyst، viewer.
- **الصلاحيات الحبيبية (Scopes)**: CRUD لكل مورد، إضافةً إلى صلاحيات خاصة مثل:
  - `inventory.create_code`, `inventory.read_count_only`, `inventory.lock_after_assign`
  - `products.sync_to_channel`, `products.exclude_channel`
  - `chat.read`, `chat.assign`, `chat.reply`
  - `campaign.create`, `campaign.metrics.read`
  - `billing.view`, `billing.refund.request`
  - `security.alerts.view`, `security.whitelist.manage`
- **مصفوفة صلاحيات لكل موظف**: تخزين التكوين في قاعدة البيانات كـ JSON، مع مثال مبين داخل الوثيقة الأصلية.
- **إخفاء الأقسام**: أي قسم لا يملك المستخدم صلاحية الوصول إليه يختفي من شبكة الإعدادات تلقائيًا.

---

## 3. سياسات المخزون والقسائم (حرجة)
- **قواعد**:
  - من يضيف القسيمة لا يستطيع تعديلها أو حذفها بعد الحفظ (قفل دائم) إلا من يملك `inventory.unlock_code`.
  - صلاحية `inventory.read_count_only` تقيّد العرض إلى الأعداد فقط لكل كود دون إظهار النص الأصلي.
  - أي محاولة تعديل أو حذف تسجّل في سجل تدقيق غير قابل للتلاعب (Append-Only).
- **واجهات مطلوبة**:
  - شاشة "إضافة قسائم جماعية" (CSV/Excel/Manual) مع فحص تلقائي للتكرار والتحقق.
  - شاشة "حالة القسائم" (صالح/مباع/مقفل/مسترد).
  - تكامل زد والقنوات الأخرى: مخزون موحّد مع كشف التعارضات وتنبيهات عند تباين العدّ.

---

## 4. ربط حقيقي مع المنصات والقنوات
- **زد (Zid)**: مصادقة رسمية، سحب ودفع المنتجات، الأسعار، المخزون، الطلبات، والحالات.
- **WhatsApp Cloud**: مزامنة الكتالوج ونشر المنتجات المختارة، وإدخال المحادثات في صندوق الوارد.
- **Instagram/Facebook Shops**: مزامنة المنتجات والوسائط والأوصاف وفق سياسات Meta.
- **البريد (IMAP/SMTP/OAuth)**: إدارة صناديق بريد متعددة وربطها بالتذاكر أو الـ Inbox.
- **Webhooks**: استقبال إشعارات الطلبات/الدفع/المرتجعات وتسجيلها في سجل النشاط.
- **التزام API**: احترام الاتفاقيات الرسمية، حدود المعدّل، الصلاحيات، والـ pagination.

---

## 5. صفحة المنتجات — مزامنة متعددة القنوات
- إنشاء المنتج مرة واحدة ثم اختيار القنوات المستهدفة (زد، واتساب، إنستغرام، المتجر...) مع خيار استثناء قنوات محددة.
- **التحسين بالذكاء الاصطناعي**:
  - توليد وصف عربي احترافي من الاسم والصورة بما يتناسب مع سياسات كل قناة.
  - اقتراح عناوين، كلمات مفتاحية، ووسوم SEO مناسبة.
  - اقتراح صور أو خلفيات عند توفر مولد صور معتمد.
- **التوافق مع القنوات**: قواعد تحقق قبل النشر (الأبعاد، طول الوصف، الكلمات الممنوعة...)
- **تعقب الحالة**: عرض حالة "مُرسل/موافق عليه/مرفوض" لكل قناة مع سبب الرفض إن وُجد.

---

## 6. صندوق محادثات موحّد (Unified Inbox)
- ويدجت محادثة مدمج داخل المتجر يربط الزائر مباشرة بلوحة الدعم.
- مصادر المحادثات: موقع المتجر، واتساب بيزنس، إنستغرام DM (عبر القنوات المعتمدة)، البريد كـ Tickets.
- خصائص الوكلاء: إظهار مصدر الزائر، تعيين المحادثة لموظف أو فريق، ملاحظات داخلية، قوالب رد، حالة الكتابة، SLAs.
- إسناد المهام والتذكيرات من داخل المحادثة وربطها بالعميل أو الطلب.

---

## 7. الحملات، القياس، والتقارير
- مدير حملات: روابط تتبع (UTM)، توليد QR، تقسيم العملاء (Segments)، رسائل متعددة القنوات.
- قياس الأداء: فتح، نقر، تحويل، عائد، مع مقارنة عبر القنوات.
- تقارير وجرد: تصدير PDF/CSV، جرد دوري، فجوات المخزون، أكثر المنتجات مبيعًا، أداء الموظفين.

---

## 8. الأمن والتنبيهات
- مراقبة الاتصالات الخارجية: لوحة تعرض النداءات (الوجهة، endpoint، عدد الطلبات)، مع قواعد حظر وقوائم بيضاء.
- تنبيهات فورية عند النشاط غير المصرح به، اختلاف المخزون، فشل المزامنة، أخطاء API، محاولات حذف قسائم مقفلة.
- تدقيق شامل لكل حدث (وقت، مستخدم، عنوان IP، العملية، البيانات المتأثرة).

---

## 9. نماذج البيانات (مختصر عملي)
- **المستخدمون والصلاحيات**:
  - `users(id, name, email, role, status, created_at)`
  - `permissions(id, code, description)`
  - `user_permissions(user_id, permission_code)`
- **المنتجات والقنوات**:
  - `products(id, sku, title, description, price, currency, status, created_by, created_at)`
  - `channels(id, code, name, status)`
  - `product_channels(product_id, channel_code, publish_status, last_sync_at, rejection_reason)`
- **المخزون والقسائم**:
  - `inventory_items(id, product_id, code_hash, code_salt, status, locked_by, locked_at, created_at)`
  - `inventory_counts(product_id, available_count, reserved_count, sold_count, last_recalc_at)`
  - ملاحظة: تخزين القسائم كنص مشفّر (hash + salt) مع عرض الأعداد فقط.
- **المراسلات والمحادثات**:
  - `inbox_threads(id, source, external_id, customer_id, assigned_to, status, created_at)`
  - `inbox_messages(id, thread_id, sender_type, body, attachments, created_at)`
  - `tasks(id, title, due_at, assigned_to, status, related_type, related_id)`
- **الحملات والتتبع**:
  - `campaigns(id, name, channel, segment_rule, start_at, end_at, status)`
  - `campaign_metrics(campaign_id, impressions, clicks, conversions, revenue, updated_at)`
- **الأمن والتدقيق**:
  - `audit_log(id, actor_id, action, target_type, target_id, metadata_json, ip, created_at)`
  - `security_events(id, severity, category, message, meta_json, created_at)`
  - `outbound_calls(id, provider, endpoint, method, status_code, latency_ms, created_at)`

---

## 10. عقود API المقترحة
- **الصلاحيات**:
  - `GET /api/rbac/scopes`
  - `GET /api/rbac/users/:id`
  - `POST /api/rbac/users/:id/overrides`
- **القسائم**:
  - `POST /api/inventory/:productId/codes/import`
  - `GET /api/inventory/:productId/counts`
  - منع التعديل/الحذف إلا بصلاحية `inventory.unlock_code`.
- **المنتجات والمزامنة**:
  - `POST /api/products`
  - `POST /api/products/:id/sync`
  - `GET /api/products/:id/channels`
- **الذكاء الاصطناعي**:
  - `POST /api/ai/describe`
- **المحادثات**:
  - `GET /api/inbox/threads`
  - `POST /api/inbox/threads/:id/assign`
  - `POST /api/inbox/threads/:id/messages`
- **الحملات**:
  - `POST /api/campaigns`
  - `GET /api/campaigns/:id/metrics`
- **الأمن**:
  - `GET /api/security/outbound`
  - `POST /api/security/whitelist`
  - Webhook: `/api/webhooks/*` مع توقيع للتحقق.

---

## 11. تجربة المستخدم والانتقالات
- انتقالات فتح الأقسام (Scale + Fade) وترتيب بصري متدرج.
- انتقالات بين الصفحات بتمرير أفقي خفيف.
- مؤشرات حالة الربط في أعلى الشبكة.
- دعم الوصولية: لوحة المفاتيح، تباين ألوان، رسائل خطأ عربية واضحة.
- الأداء: تحميل كسول، Code Splitting، Cache للـ API، منع إعادة الجلب المفرطة.

---

## 12. معايير القبول
1. شبكة الإعدادات تظهر الأقسام المصرّح بها فقط.
2. نظام RBAC يضمن أن دور seller يرى أعداد المخزون فقط ولا يمكنه تعديل القسائم.
3. إضافة قسيمة تُقفل تلقائيًا وتظهر في سجل التدقيق، ومحاولة تعديلها بدون صلاحية تنتج رسالة رفض واضحة.
4. إنشاء منتج ومزامنته إلى قناتين (زد + واتساب) مع استثناء قناة ثالثة، وتحديث الحالات بدقة.
5. ويدجت المحادثة داخل المتجر يربط المحادثات بلوحة الـ Inbox ويعرض المصدر.
6. حملة تسويقية تُنشأ، تُقاس (نقر/تحويل)، وتظهر في التقارير.
7. لوحة الأمن تسجّل الاتصالات الخارجية وتطلق التنبيهات عند الفشل أو المعدلات غير الطبيعية.
8. جميع الاتصالات تستخدم مفاتيح رسمية وتلتزم بمحددات وثائق مقدمي الخدمة.

---

## 13. خطة الإطلاق المرحلية
- **المرحلة A**: واجهة الإعدادات + RBAC + سجل التدقيق.
- **المرحلة B**: المخزون والقسائم (القفل + عرض الأعداد) وتكامل زد.
- **المرحلة C**: المنتجات متعددة القنوات + تحسين الذكاء الاصطناعي.
- **المرحلة D**: الـ Unified Inbox + البريد والتذاكر + المهام.
- **المرحلة E**: الحملات والتقارير.
- **المرحلة F**: الأمن والتنبيهات + مراقبة الاتصالات.
- كل مرحلة تتضمن اختبارات وحدات وتكامل، ملف تهيئة بيئة (ENV)، ووثائق استخدام عربية.

---

## 14. ملاحظات تنفيذية
- منع أي محاكاة؛ جميع التكاملات عبر واجهات رسمية مع التحقق من المفاتيح وتوثيق الطلبات والاستجابات.
- حماية البيانات الحساسة (Hash + Salt للقسائم) وتشفير الحقول السرية في قاعدة البيانات.
- زمن استجابة واجهة المستخدم: < 200ms محليًا و< 600ms عبر الشبكة في المتوسط.
- جميع الأخطاء تُعرض بالعربية مع رقم تتبع محفوظ في السجلات.

