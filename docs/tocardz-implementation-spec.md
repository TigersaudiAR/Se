# وثيقة طلب تطوير منصة "توكاردز"

## الهدف العام
ترقية واجهة وتجربة الاستخدام (UI/UX) وبنية الصلاحيات والتكاملات بحيث تصبح المنصة مركزًا موحّدًا لإدارة المنتجات الرقمية، المخزون، المحادثات، الحملات، التنبيهات، والتقارير مع ربط حقيقي 100٪ مع مقدّمي الخدمات المعتمدين (زد، واتساب كلود، إنستغرام/فيسبوك، البريد، وغيرها) دون أي محاكاة.

---

## 1. واجهة الإعدادات الجديدة (Settings Hub)
- **أسلوب العرض**: شبكة بطاقات (Grid) متجاوبة تعتمد CSS Grid مع fallback مناسب، بعمودين إلى ثلاثة على الجوال وأربعة إلى ستة على سطح المكتب، مع دعم RTL افتراضي وSpacing 6–8.
- **محتوى البطاقة**: أيقونة SVG دلالية، اسم القسم، وصف قصير من سطر واحد، شارة حالة الربط (متصل/غير متصل/يتطلّب تفعيل) بألوان معيارية (أخضر/رمادي/برتقالي)، ومؤشر صغير لآخر تحديث فعلي.
- **عناصر التحكم**: زر "إدارة" يفتح صفحة القسم في Overlay أو تبويب فرعي، زر "صلاحيات" يظهر للمالكين والمشرفين فقط، وزر "مزامنة الآن" للأقسام المرتبطة بتكاملات مباشرة.
- **الحالة الدائمة**: استخدام keep-alive caching أو React Router nested routes للحفاظ على حالة الشبكة والنوافذ المفتوحة عند التنقل والعودة دون فقد التركيز أو نتائج الفلترة.
- **تمييز الموظفين**: إمكانية تخصيص لون دلالي لكل موظف/دور ينعكس على نصوص نشاطه وشارات السجل لتسهيل التتبع البصري خلال التحقيقات.
- **خيارات التخصيص**: إعادة ترتيب البطاقات بالسحب والإفلات، تثبيت الأقسام المفضّلة في الأعلى، واختيار خلفية خفيفة أو صورة تحمل هوية العلامة التجارية.
- **الأقسام الأساسية**:
  1. ربط المنصات (زد، كتالوج واتساب، إنستغرام/فيسبوك، سناب عند توافر API رسمي).
  2. الموظفون والأدوار (RBAC) مع إدارة الجلسات الفعّالة وكلمات المرور الثنائية.
  3. المخزون والقسائم (إضافة، قفل، مراقبة التعارضات، سياسات القراءة).
  4. الفوترة والفواتير والمبالغ المستردّة.
  5. النشاط والتدقيق (Audit & Activity) مع فلاتر حسب الموظف ولون التمييز.
  6. البريد والتذاكر وربط صناديق بريد متعددة (IMAP/SMTP/OAuth).
  7. المحادثات الموحّدة (Unified Inbox) والويدجت المدمج في المتجر.
  8. الحملات والتسويق (روابط تتبع، QR، قوالب رسائل).
  9. التنبيهات والأمن (Outbound & Suspicious Connections) وإدارة اللوائح البيضاء/السوداء.
  10. التقارير والجرد والتحليلات المخصّصة.
  11. الذكاء الاصطناعي (تحسين وصف/SEO/صور بالعربية، اقتراحات المحتوى).
  12. التكاملات الإضافية (Webhooks، مفاتيح API، تطبيقات OAuth).
  13. إعدادات القنوات الاجتماعية ورسائل الوسائط (واتساب، إنستغرام، فيسبوك، سناب، تيك توك عند توفر التكامل).
- **متطلبات تصميمية**: دعم RTL كامل، ثيم فاتح/داكن مع تبديل حي، انتقالات ناعمة (Framer Motion أو CSSTransition)، زوايا دائرية 2XL، ظلال لطيفة، عناصر قابلة للطباعة PDF.
- **إمكانية الوصول**: تنقل كامل بلوحة المفاتيح، تباين ألوان ≥ 4.5:1، دعم قارئ الشاشة مع وصف عربي واضح لكل بطاقة.

---

## 2. نظام الصلاحيات (RBAC) دقيق وقابل للتخصيص
- **الأدوار الجاهزة**: owner، admin، finance، inventory_manager، seller، support، analyst، viewer، marketing_lead، security_officer، channel_manager.
- **الصلاحيات الحبيبية (Scopes)**: CRUD لكل مورد، إضافةً إلى صلاحيات خاصة مثل:
  - `inventory.create_code`, `inventory.read_count_only`, `inventory.lock_after_assign`, `inventory.force_recount`
  - `products.sync_to_channel`, `products.exclude_channel`, `products.ai_optimize`
  - `chat.read`, `chat.assign`, `chat.reply`, `chat.widget.configure`
  - `campaign.create`, `campaign.metrics.read`, `campaign.segment.edit`
  - `billing.view`, `billing.refund.request`, `billing.subscription.manage`
  - `security.alerts.view`, `security.whitelist.manage`, `security.outbound.block`
  - `mailbox.add_account`, `mailbox.imap.sync`, `webhooks.manage`
- **مصفوفة صلاحيات لكل موظف**: تخزين التكوين في قاعدة البيانات كـ JSON مع سجلات تاريخية (versioning) لكل تعديل، وتسجيل الجهة التي عدّلت الصلاحيات.
- **إخفاء الأقسام**: أي قسم لا يملك المستخدم صلاحية الوصول إليه يختفي من شبكة الإعدادات تلقائيًا، مع تسجيل محاولة الوصول غير المصرّح به في الـ Audit Log بلون الموظف المخصّص.
- **التدقيق اللحظي**: واجهة تعرض الصلاحيات الفعلية (Role + Overrides) وتُظهر التباينات مباشرة قبل منح الوصول لمنع الأخطاء البشرية.

---

## 3. سياسات المخزون والقسائم (حرجة)
- **قواعد**:
  - من يضيف القسيمة لا يستطيع تعديلها أو حذفها بعد الحفظ (قفل دائم) إلا من يملك `inventory.unlock_code`، مع شارة "مقفلة" ورسالة تأكيد مزدوجة قبل الإغلاق النهائي.
  - صلاحية `inventory.read_count_only` تقيّد العرض إلى الأعداد فقط لكل كود دون إظهار النص الأصلي أو الـ hash، وتُخفي الحقول الحساسة في الواجهات البرمجية ولوحة التحكم.
  - أي محاولة تعديل أو حذف تسجّل في سجل تدقيق غير قابل للتلاعب (Append-Only) مع حفظ الـ payload، عنوان الـ IP، والنتيجة، وتوليد تنبيه لحظي في لوحة الأمن عند تكرار المحاولة.
  - الصلاحية `inventory.force_recount` تتيح إعادة احتساب المخزون بناءً على بيانات القنوات الرسمية، وتُقيّد بتنبيه مزدوج يتم اعتماده من المالك أو مسؤول الأمن.
- **واجهات مطلوبة**:
  - شاشة "إضافة قسائم جماعية" (CSV/Excel/Manual) مع فحص تلقائي للتكرار والتحقق، وتقرير نهائي قبل الاعتماد.
  - شاشة "حالة القسائم" (صالح/مباع/مقفل/مسترد/قيد التحقق) مع إمكان التصفية، البحث، والفرز حسب القناة.
  - شاشة "تعقّب التعارض" تعرض مقارنة المخزون بين المنصات (زد، المتجر الإلكتروني، واتساب كتالوج) مع خيار الإرسال الفوري للتنبيهات أو إعادة المزامنة اليدوية.
  - لوحة مؤشرات تُظهر الفارق بين المخزون النظري والفعلـي لكل قناة وتقدم توصيات المعالجة.
  - تكامل زد والقنوات الأخرى: مخزون موحّد مع كشف التعارضات وتنبيهات لحظية عند تباين العدّ وفق اتفاقية مستوى الخدمة.

---

## 4. ربط حقيقي مع المنصات والقنوات
- **زد (Zid)**: مصادقة رسمية (OAuth 2.0)، سحب ودفع المنتجات، الأسعار، المخزون، الطلبات، والحالات مع احترام حدود المعدّل، وتسجيل معرف المزامنة الأخير لكل عملية.
- **WhatsApp Cloud**: مزامنة الكتالوج ونشر المنتجات المختارة، جدولة التحديثات، وإدخال المحادثات في الـ Unified Inbox مع إسناد تلقائي بناءً على قواعد الدور.
- **Instagram/Facebook Shops**: مزامنة المنتجات والوسائط والأوصاف وفق سياسات Meta بما في ذلك تحقق الجودة (Quality Check) قبل الإرسال.
- **Snapchat/TikTok**: ربط مشروط بتوفر API رسمي، مع دعم نشر العروض والكتالوجات وفق السياسات.
- **البريد (IMAP/SMTP/OAuth)**: إدارة صناديق بريد متعددة وربطها بالتذاكر أو الـ Inbox، دعم الأرشفة التلقائية عند الحل، وتحويل البريد إلى مهام.
- **Webhooks رسمية**: استقبال إشعارات الطلبات/الدفع/المرتجعات وتسجيلها في سجل النشاط، والتحقق من التوقيع، وتكرار الطلبات عند الفشل حتى النجاح أو بلوغ حد معيّن.
- **التزام API**: احترام الاتفاقيات الرسمية، حدود المعدّل، الصلاحيات، الـ pagination، واستخدام Retry/Backoff مع مراقبة الأخطاء في لوحة الأمن.
- **لوحة حالة التكاملات**: تعرض حالة الاتصال، آخر مزامنة ناجحة، عدد الأخطاء لكل موفّر، وخيار إعادة المصادقة أو تحديث رموز الوصول.

---

## 5. صفحة المنتجات — مزامنة متعددة القنوات
- إنشاء المنتج مرة واحدة ثم اختيار القنوات المستهدفة (زد، واتساب، إنستغرام، المتجر الإلكتروني، سناب، تيك توك) مع خيار استثناء قنوات محددة أو تحديد إعدادات خاصة بكل قناة (سعر، وصف مختصر، صور بديلة).
- دعم مزامنة المخزون والسعر والوسائط في وقت واحد، مع سجل زمني يوضح المسؤول عن كل تحديث وألوان الموظفين الخاصة به.
- **التحسين بالذكاء الاصطناعي**:
  - توليد وصف عربي احترافي من الاسم والصورة بما يتناسب مع سياسات كل قناة، مع توفير مستويات رسمية/عامية حسب الجمهور.
  - اقتراح عناوين، كلمات مفتاحية، ووسوم SEO مناسبة، وتوليد Meta Tags ومتغيرات Schema.org باللغة العربية.
  - اقتراح صور أو خلفيات مع ضمان التوافق مع أبعاد كل قناة، وتوفير تكامل مع مولد صور معتمد إن توفر.
  - تحليل جودة المحتوى واقتراح تحسينات قابل للتعديل قبل الاعتماد النهائي.
- **التوافق مع القنوات**: قواعد تحقق قبل النشر (الأبعاد، طول الوصف، الكلمات الممنوعة، سياسات المحتوى) مع إرشادات عربية واضحة وإيقاف أي إرسال مخالف.
- **تعقب الحالة**: عرض حالة "مُرسل/موافق عليه/قيد المراجعة/مرفوض" لكل قناة مع سبب الرفض إن وُجد، وخيار إعادة المحاولة أو تعديل المحتوى مباشرة من الجدول.
- **المهام المرتبطة**: إمكانية إنشاء مهام للفرق (تصميم، محتوى، تدقيق) مرتبطة بالمنتج لضمان الإكمال قبل النشر.

---

## 6. صندوق محادثات موحّد (Unified Inbox)
- ويدجت محادثة رسمي مدمج داخل المتجر الإلكتروني (JS SDK أو iframe موثّق) يربط الزائر مباشرة بلوحة الدعم دون مغادرة الصفحة، مع حفظ السياق حتى عند إغلاق الواجهة.
- مصادر المحادثات: موقع المتجر، واتساب بيزنس (Cloud API)، إنستغرام DM، فيسبوك Messenger، البريد الإلكتروني كـ Tickets، ونماذج الموقع.
- خصائص الوكلاء: إظهار مصدر الزائر، الدولة، الصفحة التي يتصفحها، تعيين المحادثة لموظف أو فريق، ملاحظات داخلية، قوالب رد ذكية متعددة اللغات، حالة الكتابة، مؤقت SLA، وتصعيد تلقائي عند تجاوز المهلة.
- عرض اللون المخصص للموظف على الرسائل والأحداث التي يتعامل معها لتسهيل المتابعة.
- دعم الردود الجاهزة المعتمدة على الذكاء الاصطناعي مع قدرة المراجعة قبل الإرسال.
- إسناد المهام والتذكيرات من داخل المحادثة وربطها بالعميل أو الطلب مع إشعارات عبر البريد أو التنبيهات الداخلية.
- تسجيل كل محادثة في سجل التدقيق مع معلومات كاملة (وقت، موظف، مصدر، IP، وسائط مرفقة) لضمان التتبّع.

---

## 7. الحملات، القياس، والتقارير
- مدير حملات موحّد: إنشاء حملات متعددة القنوات (واتساب، بريد، SMS، إنستغرام، سناب) مع قوالب رسائل مخصّصة، توليد روابط UTM وQR Codes ديناميكية، وجدولة الإرسال.
- تقسيم العملاء (Segments) بناءً على سلوك الشراء، تفاعل المحادثات، المخزون المتاح، وقوائم مخصّصة يتم تحديثها تلقائيًا.
- قياس الأداء: فتح، نقر، تحويل، عائد، تكلفة الاكتساب، نسبة إعادة الشراء، مع مقارنة عبر القنوات وتمثيل بصري تفاعلي.
- ربط نتائج الحملات بالمنتجات والمخزون لتحديث التوقعات وإطلاق تنبيهات عند ارتفاع الطلب عن المخزون المتاح.
- تقارير وجرد متقدمة: تصدير PDF/CSV، جرد دوري، فجوات المخزون، أكثر المنتجات مبيعًا، أداء الموظفين، وتتبع ألوان الموظفين في تقارير النشاط.
- لوحة ذكاء أعمال مبنية على Cubes أو Data Warehouse خفيف مع إمكان إنشاء تقارير مخصّصة وسيناريوهات What-if.

---

## 8. الأمن والتنبيهات
- مراقبة الاتصالات الخارجية: لوحة تعرض كل نداء طرف ثالث (الوجهة، endpoint، الحالة، زمن الاستجابة، الموظف/الخدمة المسببة) مع قواعد حظر وقوائم بيضاء قابلة للجدولة.
- تنبيهات فورية عبر القنوات (داخل التطبيق، بريد، واتساب أعمال، Webhook) عند النشاط غير المصرح به، اختلاف المخزون، فشل المزامنة، أخطاء API، ومحاولات حذف أو فتح قسائم مقفلة.
- نظام اكتشاف الشذوذ (Anomaly Detection) يتتبع معدلات الطلب، الأعطال المتكررة، وارتفاع التأخيرات، ويعرض الاقتراحات التصحيحية.
- تدقيق شامل لكل حدث (وقت، مستخدم، عنوان IP، العملية، البيانات المتأثرة) مع تمييز الألوان حسب الموظف ومسار الموافقة إن وجد.
- إمكان إنشاء سياسات أمان مخصّصة (Automation Rules) تُنفّذ إجراءات تلقائية مثل إيقاف التكامل، إرسال تنبيه لمدير الأمن، أو فرض إعادة مصادقة ثنائية.

---

## 9. نماذج البيانات (مختصر عملي)
- **المستخدمون والصلاحيات**:
  - `users(id, name, email, role, status, accent_color, created_at, last_login_at)`
  - `permissions(id, code, description, category)`
  - `user_permissions(user_id, permission_code, granted_by, granted_at)`
  - `role_sessions(id, user_id, device, ip, last_seen_at, revoked_at)`
- **المنتجات والقنوات**:
  - `products(id, sku, title, description, price, currency, status, created_by, created_at, ai_version, last_ai_opt_at)`
  - `channels(id, code, name, status, type)`
  - `product_channels(product_id, channel_code, publish_status, last_sync_at, rejection_reason, last_synced_by)`
  - `product_tasks(product_id, task_id)`
- **المخزون والقسائم**:
  - `inventory_items(id, product_id, code_hash, code_salt, status, locked_by, locked_at, created_at, added_by)`
  - `inventory_counts(product_id, available_count, reserved_count, sold_count, last_recalc_at, recount_requested_by)`
  - ملاحظة: تخزين القسائم كنص مشفّر (hash + salt) مع عرض الأعداد فقط، وتسجيل لون الموظف في واجهة العرض فقط (لا يُخزّن ضمن البيانات الحساسة).
- **المراسلات والمحادثات**:
  - `inbox_threads(id, source, external_id, customer_id, assigned_to, status, color_code, created_at, last_activity_at)`
  - `inbox_messages(id, thread_id, sender_type, body, attachments, created_at, ai_suggested)`
  - `tasks(id, title, due_at, assigned_to, status, related_type, related_id, reminder_at)`
  - `widget_sessions(id, visitor_id, started_at, last_seen_at, current_page, source_channel)`
- **الحملات والتتبع**:
  - `campaigns(id, name, channels, segment_rule, start_at, end_at, status, owner_id)`
  - `campaign_metrics(campaign_id, impressions, clicks, conversions, revenue, cac, roas, updated_at)`
  - `segments(id, name, rule_json, refreshed_at)`
- **الأمن والتدقيق**:
  - `audit_log(id, actor_id, action, target_type, target_id, metadata_json, ip, color_code, created_at)`
  - `security_events(id, severity, category, message, meta_json, created_at, escalated_to)`
  - `outbound_calls(id, provider, endpoint, method, status_code, latency_ms, retries, created_at)`
  - `automation_rules(id, name, trigger, condition_json, action_json, enabled, created_at)`

---

## 10. عقود API المقترحة
- **الصلاحيات**:
  - `GET /api/rbac/scopes`
  - `GET /api/rbac/users/:id`
  - `POST /api/rbac/users/:id/overrides`
  - `POST /api/rbac/users/:id/color` لتعيين اللون التمييزي.
  - `GET /api/rbac/sessions` لإدارة الجلسات النشطة.
- **القسائم**:
  - `POST /api/inventory/:productId/codes/import`
  - `GET /api/inventory/:productId/counts`
  - `POST /api/inventory/:productId/recount`
  - `POST /api/inventory/codes/:codeId/unlock` مع تحقق ثنائي.
- **المنتجات والمزامنة**:
  - `POST /api/products`
  - `POST /api/products/:id/sync`
  - `GET /api/products/:id/channels`
  - `POST /api/products/:id/tasks`
- **الذكاء الاصطناعي**:
  - `POST /api/ai/describe`
  - `POST /api/ai/seo`
  - `POST /api/ai/image-recommend`
- **المحادثات**:
  - `GET /api/inbox/threads`
  - `POST /api/inbox/threads/:id/assign`
  - `POST /api/inbox/threads/:id/messages`
  - `POST /api/inbox/threads/:id/tasks`
  - `GET /api/widget/sessions`
- **الحملات**:
  - `POST /api/campaigns`
  - `GET /api/campaigns/:id/metrics`
  - `GET /api/segments`
- **الأمن**:
  - `GET /api/security/outbound`
  - `POST /api/security/whitelist`
  - `POST /api/security/rules`
  - `POST /api/security/alerts/:id/escalate`
  - Webhook: `/api/webhooks/*` مع توقيع للتحقق وإعادة المحاولة التلقائية.

---

## 11. تجربة المستخدم والانتقالات
- انتقالات فتح الأقسام (Scale + Fade + Blur خفيف) وترتيب بصري متدرج مع توقيت 180ms وتلاشي بسيط.
- انتقالات بين الصفحات بتمرير أفقي خفيف (Slide + Fade) مع الحفاظ على حالة الخلفية وإبراز البطاقة المختارة.
- مؤشرات حالة الربط في أعلى الشبكة مع عدّاد حي لآخر مزامنة ورسائل حالة عربية قصيرة.
- دعم الوصولية: تنقل كامل بلوحة المفاتيح، تباين ألوان ≥ 4.5:1، رسائل خطأ عربية واضحة مع أرقام تتبع، ودعم قارئ الشاشة لكل الأيقونات.
- الأداء: تحميل كسول، Code Splitting، Cache للـ API، منع إعادة الجلب المفرطة، واستخدام Web Workers للعمليات المكثّفة (تحقق المخزون، معالجة CSV).
- ثيمات قابلة للتخصيص: دعم الثيم الفاتح/الداكن، وإمكانية ضبط ألوان العلامة التجارية ضمن حدود تضمن التباين المطلوب.

---

## 12. معايير القبول
1. شبكة الإعدادات تظهر الأقسام المصرّح بها فقط، مع تلوين نشاط كل موظف بحسب اللون المحدد له.
2. نظام RBAC يضمن أن دور seller يرى أعداد المخزون فقط ولا يمكنه تعديل أو حذف القسائم، ويُسجل أي محاولة وصول مرفوضة في سجل التدقيق.
3. إضافة قسيمة تُقفل تلقائيًا وتظهر في سجل التدقيق، ومحاولة تعديلها بدون صلاحية تنتج رسالة رفض واضحة وتنبيه أمني.
4. إنشاء منتج واحد ومزامنته إلى قناتين (زد + واتساب) مع استثناء قناة ثالثة، مع عرض الحالة لكل قناة ورسالة الرفض إن وُجدت.
5. ويدجت المحادثة داخل المتجر يعمل على المتصفح الفعلي، ينقل المحادثات للـ Inbox، ويعرض مصدر الزائر ولون الموظف المسؤول.
6. حملة تسويقية تُنشأ، تُقاس (نقر/تحويل/ROAS)، وتظهر في لوحة التقارير وتؤثر على توقعات المخزون.
7. لوحة الأمن تسجّل الاتصالات الخارجية، تعرض زمن الاستجابة، وتطلق التنبيهات الفورية عبر القنوات المحددة عند الفشل أو المعدلات غير الطبيعية.
8. جميع التكاملات تستخدم مفاتيح رسمية وتلتزم بمحددات وثائق مقدمي الخدمة، مع تسجيل كل طلب واستجابة حرجة في الـ Audit Log.

---

## 13. خطة الإطلاق المرحلية
- **المرحلة A**: واجهة الإعدادات الشبكية + تخصيص الألوان + RBAC مع إدارة الجلسات + سجل التدقيق الملون.
- **المرحلة B**: المخزون والقسائم (القفل، العدّ فقط، التعارضات) + تكامل زد الحقيقي.
- **المرحلة C**: المنتجات متعددة القنوات + مهام الفرق + تحسين الذكاء الاصطناعي للمحتوى والوسائط.
- **المرحلة D**: الـ Unified Inbox + ويدجت المتجر + البريد والتذاكر + المهام والتذكيرات المترابطة.
- **المرحلة E**: الحملات، التقارير المتقدمة، ولوحة الذكاء التجاري.
- **المرحلة F**: الأمن والتنبيهات، مراقبة الاتصالات، أتمتة السياسات، واكتشاف الشذوذ.
- كل مرحلة تتضمن اختبارات وحدات وتكامل، ملف تهيئة بيئة (ENV)، ووثائق استخدام عربية محدثة، مع خطة ترحيل بيانات عند الحاجة.

---

## 14. ملاحظات تنفيذية
- منع أي محاكاة؛ جميع التكاملات عبر واجهات رسمية مع التحقق من المفاتيح، الحفاظ على سجلات الطلب/الاستجابة، وتوثيق عمليات الاعتماد مع مزوّدي الخدمة.
- حماية البيانات الحساسة (Hash + Salt للقسائم) وتشفير الحقول السرية في قاعدة البيانات باستخدام KMS مُدار.
- زمن استجابة واجهة المستخدم: < 200ms محليًا و< 600ms عبر الشبكة في المتوسط، مع مراقبة مستمرة عبر Real User Monitoring.
- جميع الأخطاء تُعرض بالعربية مع رقم تتبع محفوظ في السجلات، وربطها بلوحة الأمن لإمكانية التصعيد.
- الالتزام بتحديثات مزوّدي الخدمة (Zid، Meta، WhatsApp) فور صدورها، مع اختبارات تكامل تلقائية قبل النشر للإنتاج.

