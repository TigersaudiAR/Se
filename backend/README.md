# TwoCards Platform Backend

منصة TwoCards عبارة عن واجهة برمجية متكاملة مبنية بواسطة FastAPI و SQLModel لإدارة المنتجات الرقمية، الأكواد، التكامل مع منصة زد، الذكاء الاصطناعي، الرسائل الفورية، وتسجيل الأحداث.

## المتطلبات

- Python 3.12
- Poetry لإدارة الحزم
- قاعدة بيانات PostgreSQL (أو SQLite للتطوير)

## الإعداد السريع

1. إنشاء ملف بيئة `.env` داخل مجلد `backend/` يحتوي على الإعدادات الحساسة الموضّحة أدناه.
2. تنصيب الحزم وتشغيل الخادم التطويري:

   ```bash
   cd backend
   poetry lock          # في حال تعديل التبعيات
   poetry install       # تنصيب المتطلبات
   poetry run uvicorn app.main:app --reload
   ```

3. لتشغيل قاعدة بيانات PostgreSQL محليًا يمكن استخدام Docker:

   ```bash
   docker run --name twocards-db -e POSTGRES_DB=twocards -e POSTGRES_USER=twocards -e POSTGRES_PASSWORD=twocards -p 5432:5432 -d postgres:16
   ```

4. فعّل المتغيرات الخاصة بالاتصال بقاعدة البيانات من خلال تعيين `DATABASE_URL` في ملف البيئة، أو اتركه فارغًا لاستخدام SQLite للتطوير.

> **ملاحظة:** في البيئات المعزولة قد يلزم تنفيذ `poetry lock` محليًا قبل `poetry install` بسبب الحاجة إلى تحميل بيانات الحزم.

## المتغيرات الأساسية

- `ZID_TOKEN`
- `OPENAI_API_KEY`
- `WA_TOKEN`
- `WA_PHONE_ID`
- `EMAIL_TOKENS`
- `ENCRYPTION_SECRET`

## التحقق من سلامة التكاملات

لتفقد حالة الربط مع منصة زد، OpenAI، واتساب والبريد المضمن، تم توفير مسار جديد:

- `GET /api/v1/system/status` — يتطلب رمز JWT لمسؤول النظام.

يعيد المسار مصفوفة من النتائج تحوي حالة كل تكامل (`configured`، `ok`، ورسالة توضيحية). يمكن تشغيل فحص يدوي عبر:

```bash
curl -H "Authorization: Bearer <TOKEN>" http://localhost:8000/api/v1/system/status
```

جميع عمليات الفحص تسجل تلقائيًا في جدول السجلات `audit_logs` لتتبع محاولات الاتصال الناجحة أو الفاشلة.

## واجهة الدردشة العامة

إضافة إلى قناة المحادثة الداخلية، يدعم الخادم الآن WebSocket مخصصًا للزوار عبر المسار `ws://<HOST>/api/v1/chat/ws/public`. كل رسالة من الزائر تحفظ باسم الزائر وتصبح متاحة لفريق العمل عبر لوحة التحكم. يمكن ربط الواجهة العامة مباشرة من الواجهة الأمامية الجاهزة.

توفر الواجهة النهائية نقاط وصول متكاملة لإدارة المستخدمين، المنتجات، الأكواد، السجلات، الإعدادات، الذكاء الاصطناعي، واتساب، والدردشة الداخلية والعامة.
